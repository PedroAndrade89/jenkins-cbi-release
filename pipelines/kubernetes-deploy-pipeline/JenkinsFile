pipeline {
    agent {
        label 'jenkins-slave'
    }
    environment {
            PATH = "/home/jenkins-slave/.local/bin/:${env.PATH}" // Add Ansible bin directory to PATH
    }
    options {
        timeout(time: 30, unit: 'MINUTES') // Timeout for the entire pipeline
    }
    stages {
        stage('Checkout') {
            steps {
                git branch: "${env.branch_name}", credentialsId: 'github-pedro', url: params.git_url
            }
        }
        stage('Install Istio') {
            steps {
                // Use 'withCredentials' to bind the kubeconfig file stored in Jenkins credentials
                withCredentials([file(credentialsId: 'nonprod-eks-kubeconf', variable: 'KUBECONFIG')]) {
                    sh '''
                    ${env.ansible_dir}/ansible-playbook playbooks/istio-install.yml -vvv
                    '''
                } // This closes the withCredentials block
            }
        }
    }
}